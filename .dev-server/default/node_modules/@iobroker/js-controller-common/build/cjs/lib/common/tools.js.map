{
  "version": 3,
  "sources": ["../../../../src/lib/common/tools.ts"],
  "sourcesContent": ["import type { Client as ObjectsClient } from '@iobroker/db-objects-redis';\nimport { appName } from '@iobroker/js-controller-common-db/tools';\nimport type { InternalLogger } from '@iobroker/js-controller-common-db/tools';\n\nexport interface OrderedInstancesObject {\n    1: ioBroker.InstanceObject[];\n    2: ioBroker.InstanceObject[];\n    3: ioBroker.InstanceObject[];\n    admin: ioBroker.InstanceObject[];\n}\n\n/**\n * Get ordered instances according to tier level\n *\n * @param objects - Objects DB\n * @param logger - logger object\n * @param logPrefix prefix for logging\n */\nexport async function getInstancesOrderedByStartPrio(\n    objects: ObjectsClient,\n    logger: InternalLogger | typeof console,\n    logPrefix = '',\n): Promise<ioBroker.InstanceObject[]> {\n    const instances: OrderedInstancesObject = { 1: [], 2: [], 3: [], admin: [] };\n    const allowedTiers = [1, 2, 3];\n\n    if (logPrefix) {\n        // append space if we have a prefix\n        logPrefix += ' ';\n    }\n\n    let doc: Awaited<ioBroker.GetObjectViewPromise<ioBroker.InstanceObject>> = { rows: [] };\n    try {\n        doc = await objects.getObjectViewAsync('system', 'instance', {\n            startkey: 'system.adapter.',\n            endkey: 'system.adapter.\\u9999',\n        });\n    } catch (e) {\n        if (e.message?.startsWith('Cannot find ')) {\n            logger.error(`${logPrefix} _design/system missing - call node ${appName}.js setup`);\n        } else {\n            logger.error(`${logPrefix} Can not get instances: ${e.message}`);\n        }\n    }\n\n    if (!doc.rows || doc.rows.length === 0) {\n        logger.info(`${logPrefix} no instances found`);\n    } else {\n        for (const row of doc.rows) {\n            if (row?.value) {\n                if (row.value._id.startsWith('system.adapter.admin')) {\n                    instances.admin.push(row.value);\n                } else if (\n                    row.value.common?.tier !== undefined &&\n                    allowedTiers.includes(Math.round(row.value.common.tier))\n                ) {\n                    instances[row.value.common.tier].push(row.value);\n                } else {\n                    // no valid tier, so put it in the last one\n                    instances['3'].push(row.value);\n                }\n            }\n        }\n    }\n\n    return [...instances.admin, ...instances['1'], ...instances['2'], ...instances['3']];\n}\n\ninterface IsInstalledFromNpmOptions {\n    /** Installed from attribute of instance/adapter object */\n    installedFrom?: ioBroker.InstalledFrom;\n    /** Name of the adapter */\n    adapterName: string;\n}\n\n/**\n * Check if the adapter has been installed from NPM\n *\n * @param options installedFrom and name information\n */\nexport function isInstalledFromNpm(options: IsInstalledFromNpmOptions): boolean {\n    const { adapterName, installedFrom } = options;\n\n    if (installedFrom === undefined) {\n        return true;\n    }\n\n    return installedFrom.startsWith(`${appName.toLowerCase()}.${adapterName}`);\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AACA;;;;;;AAAA,mBAAwB;AAiBxB,eAAsB,+BAClB,SACA,QACA,YAAY,IAAE;AAEd,QAAM,YAAoC,EAAE,GAAG,CAAA,GAAI,GAAG,CAAA,GAAI,GAAG,CAAA,GAAI,OAAO,CAAA,EAAE;AAC1E,QAAM,eAAe,CAAC,GAAG,GAAG,CAAC;AAE7B,MAAI,WAAW;AAEX,iBAAa;EACjB;AAEA,MAAI,MAAuE,EAAE,MAAM,CAAA,EAAE;AACrF,MAAI;AACA,UAAM,MAAM,QAAQ,mBAAmB,UAAU,YAAY;MACzD,UAAU;MACV,QAAQ;KACX;EACL,SAAS,GAAG;AACR,QAAI,EAAE,SAAS,WAAW,cAAc,GAAG;AACvC,aAAO,MAAM,GAAG,SAAS,uCAAuC,oBAAO,WAAW;IACtF,OAAO;AACH,aAAO,MAAM,GAAG,SAAS,2BAA2B,EAAE,OAAO,EAAE;IACnE;EACJ;AAEA,MAAI,CAAC,IAAI,QAAQ,IAAI,KAAK,WAAW,GAAG;AACpC,WAAO,KAAK,GAAG,SAAS,qBAAqB;EACjD,OAAO;AACH,eAAW,OAAO,IAAI,MAAM;AACxB,UAAI,KAAK,OAAO;AACZ,YAAI,IAAI,MAAM,IAAI,WAAW,sBAAsB,GAAG;AAClD,oBAAU,MAAM,KAAK,IAAI,KAAK;QAClC,WACI,IAAI,MAAM,QAAQ,SAAS,UAC3B,aAAa,SAAS,KAAK,MAAM,IAAI,MAAM,OAAO,IAAI,CAAC,GACzD;AACE,oBAAU,IAAI,MAAM,OAAO,IAAI,EAAE,KAAK,IAAI,KAAK;QACnD,OAAO;AAEH,oBAAU,GAAG,EAAE,KAAK,IAAI,KAAK;QACjC;MACJ;IACJ;EACJ;AAEA,SAAO,CAAC,GAAG,UAAU,OAAO,GAAG,UAAU,GAAG,GAAG,GAAG,UAAU,GAAG,GAAG,GAAG,UAAU,GAAG,CAAC;AACvF;AAcM,SAAU,mBAAmB,SAAkC;AACjE,QAAM,EAAE,aAAa,cAAa,IAAK;AAEvC,MAAI,kBAAkB,QAAW;AAC7B,WAAO;EACX;AAEA,SAAO,cAAc,WAAW,GAAG,qBAAQ,YAAW,CAAE,IAAI,WAAW,EAAE;AAC7E;",
  "names": []
}
